name: Setup Environment Test

on:
  push:
    branches: [main]
    paths:
      - 'setup.sh'
      - 'scripts/utils.sh'
  pull_request:
    branches: [main]
    paths:
      - 'setup.sh'
      - 'scripts/utils.sh'

jobs:
  test-setup:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run setup script
        shell: sh
        run: |
          chmod +x ./setup.sh
          ./setup.sh --debug

      - name: Verify directories created
        shell: sh
        run: |
          for d in "$HOME/Developer/personal" "$HOME/Developer/clients" \
                   "$HOME/Developer/study" "$HOME/Developer/work"; do
            if [ ! -d "$d" ]; then
              printf "Missing directory: $d"
              exit 1
            fi
          done

      - name: Verify symlinked dotfiles
        shell: sh
        run: |
          for f in .gitconfig .vimrc .zshrc; do
            target="$HOME/$f"
            if [ -e "$target" ] && [ ! -L "$target" ]; then
              printf "$target exists but is not a symlink"
              exit 1
            fi
          done

      - name: Verify colors directory exists
        shell: sh
        run: |
          if [ ! -d "$HOME/.config/colors" ]; then
            printf "~/.config/colors directory missing"
            exit 1
          fi
          if [ ! -d "$HOME/.vim/colors" ]; then
            printf "~/.vim/colors directory missing"
            exit 1
          fi

      - name: Ensure SSH key exists
        shell: sh
        run: |
          if [ ! -f "$HOME/.ssh/id_ed25519" ]; then
            printf "SSH Key generation failed"
            exit 1
          fi

      - name: List files for debugging
        if: failure()
        shell: sh
        run: |
          printf "Home directory contents:"
          ls -la "$HOME"
          printf "Config directory contents:"
          ls -la "$HOME/.config"
